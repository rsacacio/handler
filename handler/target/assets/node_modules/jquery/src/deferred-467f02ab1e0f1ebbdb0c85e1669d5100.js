define(["./core","./var/slice","./callbacks"],function(c,m){c.extend({Deferred:function(g){var a=[["resolve","done",c.Callbacks("once memory"),"resolved"],["reject","fail",c.Callbacks("once memory"),"rejected"],["notify","progress",c.Callbacks("memory")]],f="pending",b={state:function(){return f},always:function(){e.done(arguments).fail(arguments);return this},then:function(){var h=arguments;return c.Deferred(function(d){c.each(a,function(a,f){var l=c.isFunction(h[a])&&h[a];e[f[1]](function(){var a=
l&&l.apply(this,arguments);if(a&&c.isFunction(a.promise))a.promise().done(d.resolve).fail(d.reject).progress(d.notify);else d[f[0]+"With"](this===b?d.promise():this,l?[a]:arguments)})});h=null}).promise()},promise:function(a){return null!=a?c.extend(a,b):b}},e={};b.pipe=b.then;c.each(a,function(c,d){var k=d[2],g=d[3];b[d[1]]=k.add;g&&k.add(function(){f=g},a[c^1][2].disable,a[2][2].lock);e[d[0]]=function(){e[d[0]+"With"](this===e?b:this,arguments);return this};e[d[0]+"With"]=k.fireWith});b.promise(e);
g&&g.call(e,e);return e},when:function(g){var a=0,f=m.call(arguments),b=f.length,e=1!==b||g&&c.isFunction(g.promise)?b:0,h=1===e?g:c.Deferred(),d=function(a,c,b){return function(d){c[a]=this;b[a]=1<arguments.length?m.call(arguments):d;b===k?h.notifyWith(c,b):--e||h.resolveWith(c,b)}},k,n,l;if(1<b)for(k=Array(b),n=Array(b),l=Array(b);a<b;a++)f[a]&&c.isFunction(f[a].promise)?f[a].promise().done(d(a,l,f)).fail(h.reject).progress(d(a,n,k)):--e;e||h.resolveWith(l,f);return h.promise()}});return c});